services:
  # Copy file from host then install pnpm packages for frontend and backend together
  initializer:
    image: node:23
    container_name: hallucinet-initializer
    restart: on-failure
    volumes:
      - ./:/src/
      - hallucinet:/app/
    command: /bin/bash -c "
      cp /src/* /app/ -r &&

      npm install -g pnpm@latest &&
      echo '===== app/backend =====' &&
      cd /app/backend/ && pnpm install --optimistic-repeat-install &&
      echo '===== app/frontend =====' &&
      cd /app/frontend/ && pnpm install --optimistic-repeat-install &&
      echo '===== app/coordination_server =====' &&
      cd /app/coordination_server/ && pnpm install --optimistic-repeat-install
      "

  # Sync files from host to docker volume every 5 seconds so hot reloads work
  syncer:
    image: servercontainers/rsync
    container_name: hallucinet-syncer
    volumes:
      - ./:/src/
      - hallucinet:/app/
    command: /bin/bash -c "
      while true; do
      rsync -avch --exclude=node_modules/ --exclude=.next/ --exclude=.pnpm-store/ --cvs-exclude /src/ /app/ &&
      sleep 5;
      done;
      "
    depends_on:
      initializer:
        condition: service_completed_successfully

  backend:
    image: node:23
    container_name: hallucinet-backend
    restart: on-failure
    env_file:
      - ./backend/.env
    working_dir: /app/backend/
    volumes:
      - hallucinet:/app/
    command: /bin/bash -c "npm install -g pnpm@latest && pnpm run start:dev"
    depends_on:
      initializer:
        condition: service_completed_successfully

  frontend:
    image: node:23
    container_name: hallucinet-frontend
    restart: on-failure
    working_dir: /app/frontend/
    volumes:
      - hallucinet:/app/
    command: /bin/bash -c "npm install -g pnpm@latest && pnpm run dev"
    depends_on:
      initializer:
        condition: service_completed_successfully

  coordination_server:
    image: node:23
    container_name: hallucinet-coordination-server
    restart: on-failure
    env_file:
      - ./coordination_server/.env
    working_dir: /app/coordination_server/
    volumes:
      - hallucinet:/app/
    command: /bin/bash -c "npm install -g pnpm@latest && pnpm run start:dev"
    depends_on:
      initializer:
        condition: service_completed_successfully

  nginx:
    image: nginx:latest
    container_name: hallucinet-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - 80:80
    depends_on:
      initializer:
        condition: service_completed_successfully

volumes:
  hallucinet:
